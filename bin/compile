#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -euo pipefail

BUILD_DIR=$(cd "$1" && pwd)
CACHE_DIR=$(cd "$2" && pwd)

GS_VERSION="10.06.0"
GS_SHORT="10060"

PACKAGE_URL="https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs${GS_SHORT}/ghostscript-${GS_VERSION}.tar.gz"
CACHE_TAR="${CACHE_DIR}/ghostscript-${GS_VERSION}.tar.gz"

# Where we will "install" gs inside the slug
PREFIX="${BUILD_DIR}/vendor/ghostscript"

echo "-----> Installing Ghostscript ${GS_VERSION} using build directory ${BUILD_DIR}"

mkdir -p "${CACHE_DIR}" "${PREFIX}"

download_tarball() {
  local tmp="${CACHE_TAR}.download"
  echo "-----> Downloading Ghostscript source"
  curl -fsSL "${PACKAGE_URL}" -o "${tmp}"
  mv "${tmp}" "${CACHE_TAR}"
}

if [[ ! -f "${CACHE_TAR}" ]]; then
  download_tarball
fi

TMP_DIR="$(mktemp -d)"
cleanup() { rm -rf "${TMP_DIR}"; }
trap cleanup EXIT

extract() {
  if ! tar xzf "${CACHE_TAR}" -C "${TMP_DIR}"; then
    echo "-----> Cached tarball invalid; re-downloading"
    rm -f "${CACHE_TAR}"
    download_tarball
    tar xzf "${CACHE_TAR}" -C "${TMP_DIR}"
  fi
}
extract

SRC_DIR="$(find "${TMP_DIR}" -maxdepth 1 -type d -name "ghostscript-${GS_VERSION}" | head -n1)"
if [[ -z "${SRC_DIR}" || ! -d "${SRC_DIR}" ]]; then
  echo "ERROR: source directory not found after extract"
  ls -la "${TMP_DIR}" || true
  exit 1
fi

# Build
echo "-----> Configuring Ghostscript"
# Common flags to keep it lean; adjust as you need
pushd "${SRC_DIR}" >/dev/null
./configure --prefix="${PREFIX}" --disable-cups --without-x

echo "-----> Building Ghostscript (this can take a few minutes)"
make -j"$(nproc)"

echo "-----> Installing Ghostscript to ${PREFIX}"
make install
popd >/dev/null

# Verify
if ! "${PREFIX}/bin/gs" --version >/dev/null 2>&1; then
  echo "ERROR: gs did not install correctly"
  exit 1
fi
echo "-----> Ghostscript installed: $("${PREFIX}/bin/gs" --version)"

# Export PATH for runtime
mkdir -p "${BUILD_DIR}/.profile.d"
cat > "${BUILD_DIR}/.profile.d/ghostscript.sh" <<'EOF'
export PATH="$HOME/vendor/ghostscript/bin:$PATH"
EOF

echo "-----> Exported PATH for Ghostscript"